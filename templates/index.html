<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–¢–∞–∫—Å—ñ | –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      padding-top: 70px;
      background-color: #f8fdf8;
    }
    .navbar {
      background-color: #198754 !important;
    }
    .navbar-brand, .nav-link {
      color: #fff !important;
    }
    #map {
      height: 500px;
      border: 3px solid #198754;
      border-radius: 10px;
    }
    .form-control {
      border-radius: 20px;
    }
    .autocomplete-suggestions {
      position: absolute;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
      border-radius: 10px;
    }
    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background: #e9fbe9;
    }
    .output-box {
      margin-top: 1rem;
      background: #e9fbe9;
      border-left: 5px solid #198754;
      padding: 1rem;
      border-radius: 10px;
    }
    /* Footer */
    footer {
      background: #2e8b57;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é -->
  <nav class="navbar navbar-expand-lg fixed-top shadow">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">üöñ –¢–∞–∫—Å—ñ</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a id="navRide" class="nav-link" href="#ride">–ü–æ—ó–∑–¥–∫–∞</a></li>
          <li class="nav-item"><a id="navTariff" class="nav-link" href="#tariffs">–¢–∞—Ä–∏—Ñ–∏</a></li>
        </ul>
      </div>
              <div class="d-flex align-items-center ms-auto">
  <select id="languageSwitcher" class="form-select w-auto">
    <option value="uk">üá∫üá¶ UA</option>
    <option value="en">üá¨üáß EN</option>
    <option value="pl">üáµüá± PL</option>
  </select>
</div>
    </div>
  </nav>

  <!-- –°–µ–∫—Ü—ñ—è –ø–æ—ó–∑–¥–∫–∏ -->
  <section id="ride" class="container">
    <h2 class="mb-4 text-success">–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</h2>
    <div class="row mb-3">
      <div class="col-md-6 position-relative">
        <label class="form-label" for="start" id="label-start">üìç –ú—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏</label>
        <div class="d-flex gap-2">
          <input id="start" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏" oninput="searchLocation(this, 'start')" autocomplete="off">
          <button id="chooseMarkerButton1" class="btn btn-success" onclick="enableMapClick('start')">–û–±—Ä–∞—Ç–∏</button>
        </div>
        <div id="start-suggestions" class="autocomplete-suggestions"></div>
      </div>
      <div class="col-md-6 position-relative">
        <label class="form-label" for="end" id="label-end">üìç –ú—ñ—Å—Ü–µ –≤–∏—Å–∞–¥–∫–∏</label>
        <div class="d-flex gap-2">
          <input id="end" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏" oninput="searchLocation(this, 'end')" autocomplete="off">
          <button id="chooseMarkerButton2" class="btn btn-success" onclick="enableMapClick('end')">–û–±—Ä–∞—Ç–∏</button>
        </div>
        <div id="end-suggestions" class="autocomplete-suggestions"></div>
      </div>
    </div>
    <div id="map" class="mb-3"></div>
    <div id="distance" class="output-box text-dark fw-medium"></div>
  </section>

<!-- –°–µ–∫—Ü—ñ—è —Ç–∞—Ä–∏—Ñ—ñ–≤ -->
<section id="tariffs" class="container mt-5">
  <h2 class="mb-4 text-success">üìã –¢–∞—Ä–∏—Ñ–∏</h2>
  <div class="row g-4">
    <div class="col-md-6 col-lg-3 d-flex">
      <div class="card border-success shadow h-100 w-100">
        <div class="card-body">
          <h5 class="card-title text-success">Tariff I</h5>
          <p class="card-text"><strong>Price:</strong> 2.82 PLN/km</p>
          <p class="card-text small">The rate per kilometer applied on weekdays within the administrative boundaries of the city.</p>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3 d-flex">
      <div class="card border-success shadow h-100 w-100">
        <div class="card-body">
          <h5 class="card-title text-success">Tariff II</h5>
          <p class="card-text"><strong>Price:</strong> 3.15 PLN/km</p>
          <p class="card-text small">Applied during nighttime hours from 10:00 PM to 6:00 AM and on Sundays and public holidays.</p>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3 d-flex">
      <div class="card border-success shadow h-100 w-100">
        <div class="card-body">
          <h5 class="card-title text-success">Tariff III</h5>
          <p class="card-text"><strong>Price:</strong> 3.79 PLN/km</p>
          <p class="card-text small">Weekdays between 6:00 AM and 10:00 PM outside the city limits.</p>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3 d-flex">
      <div class="card border-success shadow h-100 w-100">
        <div class="card-body">
          <h5 class="card-title text-success">Tariff IV</h5>
          <p class="card-text"><strong>Price:</strong> 4.00 PLN/km</p>
          <p class="card-text small">Nighttime or Sundays/holidays outside the city limits.</p>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- Modal -->
<div class="modal fade" id="confirmRouteModal" tabindex="-1" aria-labelledby="confirmRouteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmRouteModalLabel">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
      </div>
      <div class="modal-body">
        –í–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç–µ –æ–±—Ä–∞–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button id="confirmRouteBtn" type="button" class="btn btn-success">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
      </div>
    </div>
  </div>
</div>
  <button id="checkout-button">–û–ø–ª–∞—Ç–∏—Ç–∏</button>

  <footer>
    &copy; 2025 Taxi Service. –í—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω–æ.
  </footer>


  <!-- Bootstrap JS (–ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –º–æ–¥–∞–ª–æ–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://secure.wayforpay.com/server/pay-widget.js"></script>


  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([50.0647, 19.9450], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let startMarker, endMarker, routeLayer;
    let startCoords = null, endCoords = null;
    let currentInputType = null;

document.getElementById('confirmRouteBtn').addEventListener('click', async () => {
  try {
    const amount = 12.50; // –û—Ç—Ä–∏–º–∞–π —Ü—é —Å—É–º—É –∑ —Ç–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É
    const email = "client@example.com"; // –ó–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ñ
    const phone = "+380991234567";

    const res = await fetch('/get-order-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount, email, phone })
    });

    const orderData = await res.json();

    const wayforpay = new Wayforpay();
    wayforpay.run(orderData,
      function (response) {
        console.log("‚úÖ –ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π:", response);
        alert("–ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π!");
      },
      function (response) {
        console.log("‚ö†Ô∏è –ü–ª–∞—Ç—ñ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:", response);
        alert("–ü–ª–∞—Ç—ñ–∂ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
      },
      function (response) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞:", response);
        alert("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç—ñ.");
      }
    );
  } catch (err) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø–ª–∞—Ç–µ–∂—É:", err);
  }
});

async function isWithinCity(lat, lon) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await response.json();
    console.log('Reverse geocoding data:', data); // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö

    // –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∞–¥—Ä–µ—Å–∞ –º—ñ—Å—Ç–∏—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞
    return data.address.city;
  } catch (error) {
    console.error('Error in isWithinCity:', error);
    return false;
  }
}
    function enableMapClick(type) {
      currentInputType = type;
      alert(`–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É, —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ —Ç–æ—á–∫—É –¥–ª—è ${type === 'start' ? '–ø–æ—Å–∞–¥–∫–∏' : '–≤–∏—Å–∞–¥–∫–∏'}.`);
    }

    map.on('click', (e) => {
      if (!currentInputType) return;
      const latlng = e.latlng;
      setMarker(currentInputType, latlng, currentInputType === 'start' ? '–ü–æ—Å–∞–¥–∫–∞ (–∑ –∫–∞—Ä—Ç–∏)' : '–í–∏—Å–∞–¥–∫–∞ (–∑ –∫–∞—Ä—Ç–∏)');
      document.getElementById(currentInputType).value = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
      currentInputType = null;
    });

    function setMarker(type, latlng, label) {
      if (type === 'start') {
        if (startMarker) map.removeLayer(startMarker);
        startCoords = [latlng.lng, latlng.lat];
        startMarker = L.marker(latlng).addTo(map).bindPopup(label).openPopup();
      } else {
        if (endMarker) map.removeLayer(endMarker);
        endCoords = [latlng.lng, latlng.lat];
        endMarker = L.marker(latlng).addTo(map).bindPopup(label).openPopup();
      }

      if (startCoords && endCoords) {
        getRoute(startCoords, endCoords);
      }
    }

    function searchLocation(input, type) {
      const query = input.value;
      const suggestionsBox = document.getElementById(`${type}-suggestions`);
      suggestionsBox.innerHTML = '';
      if (query.length < 3) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(results => {
          suggestionsBox.innerHTML = '';
          results.forEach(result => {
            const div = document.createElement('div');
            div.classList.add('autocomplete-suggestion');
            div.textContent = result.display_name;
            div.onclick = () => {
              input.value = result.display_name;
              const latlng = L.latLng(result.lat, result.lon);
              setMarker(type, latlng, type === 'start' ? '–ü–æ—Å–∞–¥–∫–∞ (–ø–æ—à—É–∫)' : '–í–∏—Å–∞–¥–∫–∞ (–ø–æ—à—É–∫)');
              map.setView(latlng, 14);
              suggestionsBox.innerHTML = '';
            };
            suggestionsBox.appendChild(div);
          });
        });
    }

async function getRoute(start, end) {
  try {
    const response = await fetch('/route', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ coordinates: [start, end] })
    });
    const data = await response.json();

    if (!data || !data.features || !data.features[0]) {
      document.getElementById('distance').innerText = '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!';
      return;
    }

    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(data, {
      style: { color: 'green', weight: 5 }
    }).addTo(map);

    const distance = data.features[0].properties.summary.distance / 1000;
    const tariffInfo = await getTariff(start, end);
    const price = distance * tariffInfo.rate;

    document.getElementById('distance').innerHTML =
      `üöó <b>–î–æ–≤–∂–∏–Ω–∞ –º–∞—Ä—à—Ä—É—Ç—É:</b> ${distance.toFixed(2)} –∫–º<br>` +
      `üí∞ <b>–¢–∞—Ä–∏—Ñ:</b> ${tariffInfo.name} (${tariffInfo.rate.toFixed(2)} PLN/–∫–º)<br>` +
      `üßæ <b>–í–∞—Ä—Ç—ñ—Å—Ç—å:</b> ${price.toFixed(2)} PLN`;
  } catch (error) {
    console.error('Error fetching route:', error);
    document.getElementById('distance').innerText = '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –º–∞—Ä—à—Ä—É—Ç—É';
  }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª–∫—É
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmRouteModal'));
    confirmModal.show();
}

async function getTariff(startCoords, endCoords) {
  try {
    const isStartInsideCity = await isWithinCity(startCoords[1], startCoords[0]);
    const isEndInsideCity = await isWithinCity(endCoords[1], endCoords[0]);
    console.log('Start inside city:', isStartInsideCity); // –õ–æ–≥—É–≤–∞–Ω–Ω—è
    console.log('End inside city:', isEndInsideCity); // –õ–æ–≥—É–≤–∞–Ω–Ω—è

    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    const isNight = hour >= 22 || hour < 6;
    const isSunday = day === 0;

    if (isNight || isSunday) {
      return isStartInsideCity && isEndInsideCity ? { name: "Tariff II", rate: 3.15 } : { name: "Tariff IV", rate: 4.00 };
    } else {
      return isStartInsideCity && isEndInsideCity ? { name: "Tariff I", rate: 2.82 } : { name: "Tariff III", rate: 3.79 };
    }
  } catch (error) {
    console.error('Error in getTariff:', error);
    return { name: "Unknown", rate: 0 };
  }
}
  </script>

<script>
  const translations = {
    uk: {
        navRide: "–ü–æ—ó–∑–¥–∫–∞",
        navTariff: "–¢–∞—Ä–∏—Ñ–∏",
      rideTitle: "–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É",
      pickup: "üìç –ú—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏",
        chooseMarkerButton: "–û–±—Ä–∞—Ç–∏",
      dropoff: "üìç –ú—ñ—Å—Ü–µ –≤–∏—Å–∞–¥–∫–∏",
      tariffTitle: "üìã –¢–∞—Ä–∏—Ñ–∏",
      tariffs: [
        { name: "–¢–∞—Ä–∏—Ñ I", desc: "–¶—ñ–Ω–∞: 2.82 PLN/–∫–º", info: "–¢–∞—Ä–∏—Ñ —É –º–µ–∂–∞—Ö –º—ñ—Å—Ç–∞ –≤ –±—É–¥–Ω—ñ –¥–Ω—ñ." },
        { name: "–¢–∞—Ä–∏—Ñ II", desc: "–¶—ñ–Ω–∞: 3.15 PLN/–∫–º", info: "–ù—ñ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ —Ç–∞ –≤–∏—Ö—ñ–¥–Ω—ñ." },
        { name: "–¢–∞—Ä–∏—Ñ III", desc: "–¶—ñ–Ω–∞: 3.79 PLN/–∫–º", info: "–ë—É–¥–Ω—ñ –∑–∞ –º–µ–∂–∞–º–∏ –º—ñ—Å—Ç–∞." },
        { name: "–¢–∞—Ä–∏—Ñ IV", desc: "–¶—ñ–Ω–∞: 4.00 PLN/–∫–º", info: "–ù—ñ—á –∞–±–æ –≤–∏—Ö—ñ–¥–Ω—ñ –∑–∞ –º–µ–∂–∞–º–∏ –º—ñ—Å—Ç–∞." }
      ]
    },
    en: {
        navRide: "Ride",
        navTariff: "Tariffs",
      rideTitle: "Route Planning",
      pickup: "üìç Pickup Location",
        chooseMarkerButton: "Choose",
      dropoff: "üìç Drop-off Location",
      tariffTitle: "üìã Tariffs",
      tariffs: [
        { name: "Tariff I", desc: "Price: 2.82 PLN/km", info: "Weekday city rate." },
        { name: "Tariff II", desc: "Price: 3.15 PLN/km", info: "Night and holiday rate." },
        { name: "Tariff III", desc: "Price: 3.79 PLN/km", info: "Weekday suburban rate." },
        { name: "Tariff IV", desc: "Price: 4.00 PLN/km", info: "Night or weekend suburban rate." }
      ]
    },
    pl: {
        navRide: "Poizdka",
        navTariff: "Taryfy",
      rideTitle: "Planowanie trasy",
      pickup: "üìç Miejsce odbioru",
      chooseMarkerButton: "Vibrac",
      dropoff: "üìç Miejsce wysadzenia",
      tariffTitle: "üìã Taryfy",
      tariffs: [
        { name: "Taryfa I", desc: "Cena: 2.82 PLN/km", info: "Stawka dzienna w mie≈õcie." },
        { name: "Taryfa II", desc: "Cena: 3.15 PLN/km", info: "Noc i ≈õwiƒôta." },
        { name: "Taryfa III", desc: "Cena: 3.79 PLN/km", info: "Dzienna poza miastem." },
        { name: "Taryfa IV", desc: "Cena: 4.00 PLN/km", info: "Noc lub ≈õwiƒôta poza miastem." }
      ]
    }
  };

  document.getElementById('languageSwitcher').addEventListener('change', function () {
    const lang = this.value;
    const t = translations[lang];

    // –ó–∞–º—ñ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
    document.querySelector('#ride h2').textContent = t.rideTitle;
    document.getElementById('label-start').textContent = t.pickup;
    document.getElementById('label-end').textContent = t.dropoff;
    document.querySelector('#tariffs h2').textContent = t.tariffTitle;

    document.querySelector('#chooseMarkerButton1').textContent = t.chooseMarkerButton;
    document.querySelector('#chooseMarkerButton2').textContent = t.chooseMarkerButton;

    document.querySelector('#navRide').textContent = t.navRide;
    document.querySelector('#navTariff').textContent = t.navTariff;

    // –ó–∞–º—ñ–Ω–∞ —Ç–∞—Ä–∏—Ñ—ñ–≤
    const cards = document.querySelectorAll('#tariffs .card');
    cards.forEach((card, index) => {
      card.querySelector('.card-title').textContent = t.tariffs[index].name;
      const paragraphs = card.querySelectorAll('.card-text');
      paragraphs[0].textContent = t.tariffs[index].desc;
      paragraphs[1].textContent = t.tariffs[index].info;
    });
  });
</script>

  <script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('pk_test_51RE7BEPFfDXYRYYJDO3ubsoT4BwW3V6GSVutYTRJ3b3pkcrK89wM7EYkPlJJSKsqw57R5rYVykXCUuUEfrK6uSCl000lUoBaAb');

  document.getElementById("checkout-button").addEventListener("click", () => {
    fetch("/create-checkout-session", {
      method: "POST",
    })
    .then(res => res.json())
    .then(data => {
      return stripe.redirectToCheckout({ sessionId: data.id });
    })
    .catch(error => console.error("Error:", error));
  });
</script>

</body>
</html>
